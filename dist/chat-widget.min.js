/*!
 * LuisByt Chat Widget v1.0.7
 * https://github.com/luis-byt/chat-widget
 * ¬© 2025 Byt
 * MIT License
 */
var ChatWidget=function(){"use strict";function t(t){this.baseUrl=t.apiBaseUrl,this.token=t.token,this.endpoints=t.endpoints||{}}function e(t){this.wsBaseUrl=t.wsBaseUrl,this.token=t.token,this.socket=null}function n(t){if(!t)return"";var e=new Date(t),n=new Date,i=new Date(n.getFullYear(),n.getMonth(),n.getDate()),a=new Date(e.getFullYear(),e.getMonth(),e.getDate()),s=Math.floor((i-a)/864e5);return 0===s?e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):1===s?"Ayer":e.toLocaleDateString()}function i(t){if(!t)return"Sin mensajes";if(t.attachments&&t.attachments.length>0){const e=t.attachments.length;return 1===e?"1 Adjunto":`${e} Adjuntos`}if(t.text){const e=t.text.trim();return e.length>40?e.slice(0,40)+"‚Ä¶":e}return"Mensaje"}function a(n){this.options=n||{},this.closeOnOutsideClick=!!this.options.closeOnOutsideClick,this.options.position=n.position||"bottom-right",this.api=new t(n),this.ws=new e(n),this.state={isOpen:!1,view:"inbox",inbox:{loading:!1,conversations:[]},contacts:{loading:!1,list:[]},conversation:{id:null,receiver:null,messages:[],loading:!1}},this.launcher=null,this.container=null,this.pendingAttachments=[],this.pendingText="",this.pendingMessageId=null,this.isSending=!1,this.totalUnread=0}return t.prototype.request=function(t,e,n){return fetch(this.baseUrl+t,{method:e||"GET",headers:{"Content-Type":"application/json",Authorization:"JWT "+this.token},body:n?JSON.stringify(n):null}).then(function(t){if(!t.ok)throw new Error("API error");return t.json()})},t.prototype.getInbox=function(){return this.request(this.endpoints.inbox)},t.prototype.getContacts=function(){return this.request(this.endpoints.contacts)},t.prototype.createConversation=function(t,e){return this.request(this.endpoints.createConversation,"POST",{contact_id:t,contact_role:e})},t.prototype.getMessages=function(t){return this.request(this.endpoints.messages(t))},t.prototype.uploadAttachment=function(t,e){var n=new FormData;return n.append("file",e),fetch(this.baseUrl+this.endpoints.uploadAttachment(t),{method:"POST",headers:{Authorization:"JWT "+this.token},body:n}).then(function(t){if(!t.ok)throw new Error("Upload failed");return t.json()})},e.prototype.connect=function(t,e){var n=this.wsBaseUrl+"/ws/chat/"+t+"/?token="+this.token;this.socket=new WebSocket(n),this.socket.onopen=function(){e.onOpen&&e.onOpen()},this.socket.onmessage=function(t){var n=JSON.parse(t.data);e.onMessage&&e.onMessage(n)},this.socket.onclose=function(){e.onClose&&e.onClose()},this.socket.onerror=function(t){console.error("WS error",t)}},e.prototype.send=function(t){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send(JSON.stringify(t))},e.prototype.disconnect=function(){this.socket&&(this.socket.close(),this.socket=null)},a.prototype.mount=function(){this._createLauncher(),this._createWidget(),this._render()},a.prototype._createLauncher=function(){var t=document.createElement("div");t.className="aware-chat-launcher position-"+this.options.position,t.innerHTML=`\n      <i class="${this.options.logo}"></i>\n      <span class="launcher-badge hidden" id="launcher-badge"></span>\n    `;var e=this.options.primaryColor||"#0d6efd";t.style.setProperty("--aware-primary",e),t.onclick=function(t){t.stopPropagation(),this.toggle()}.bind(this),document.body.appendChild(t),this.launcher=t},a.prototype._createWidget=function(){var t=document.createElement("div");t.className="aware-chat-widget hidden position-"+this.options.position;var e=this.options.primaryColor||"#0d6efd";t.style.setProperty("--aware-primary",e),t.addEventListener("click",function(t){t.stopPropagation()}),document.body.appendChild(t),this.container=t,this._createImageModal()},a.prototype._syncWidgetPosition=function(){if(this.launcher&&this.container){var t=this.launcher.getBoundingClientRect();this.container.offsetWidth;var e=window.innerWidth;this.container.style.bottom=window.innerHeight-t.top+12+"px",this.container.style.top="auto",this.container.style.left="auto",this.container.style.right="auto",this.container.style.transform="none";var n=t.left+t.width/2;n<.33*e?this.container.style.left=t.left+"px":n>.66*e?this.container.style.right=e-t.right+"px":(this.container.style.left=n+"px",this.container.style.transform="translateX(-50%)")}},a.prototype._createImageModal=function(){var t=document.createElement("div");t.className="aware-image-modal hidden",t.innerHTML='\n      <div class="aware-image-modal-backdrop"></div>\n      <div class="aware-image-modal-content">\n        <img src="" alt="Preview" />\n        <button class="aware-image-modal-close">‚úï</button>\n      </div>\n    ',document.body.appendChild(t),this.imageModal=t;var e=this;t.querySelector(".aware-image-modal-backdrop").onclick=function(t){t.stopPropagation(),e._closeImageModal()},t.querySelector(".aware-image-modal-content").onclick=function(t){t.stopPropagation()},t.querySelector(".aware-image-modal-close").onclick=function(t){t.stopPropagation(),e._closeImageModal()},document.addEventListener("keydown",function(t){"Escape"===t.key&&(t.stopPropagation(),e._closeImageModal())})},a.prototype._openImageModal=function(t){this.imageModal&&(this.imageModal.querySelector("img").src=t,setTimeout(()=>{this.imageModal.classList.remove("hidden")},0))},a.prototype._closeImageModal=function(){this.imageModal&&(this.imageModal.querySelector("img").src="",this.imageModal.classList.add("hidden"))},a.prototype.toggle=function(){if(this.state.isOpen=!this.state.isOpen,!this.state.isOpen)return this.container.classList.add("hidden"),this.closeOnOutsideClick&&document.removeEventListener("click",this._outsideClickHandler),void this._resetWidget();this.container.classList.remove("hidden"),this._syncWidgetPosition(),this.state.view="inbox",this._render(),this.closeOnOutsideClick&&(this._outsideClickHandler=this._outsideClickHandler||this._handleOutsideClick.bind(this),document.addEventListener("click",this._outsideClickHandler))},a.prototype.navigate=function(t,e,n){if(this.state.view=t,this.state.conversation.id=e||null,this.state.conversation.receiver=n||null,"conversation"===t&&e){var i=this.state.inbox.conversations.find(t=>t.id===e);i&&i.unread_count&&(this.totalUnread-=i.unread_count,i.unread_count=0,this._renderLauncherBadge()),this._clearInboxBadge(e)}this._render()},a.prototype._handleOutsideClick=function(t){this.state.isOpen&&(this.container.contains(t.target)||this.launcher.contains(t.target)||this.toggle())},a.prototype._render=function(){this.container&&(this.container.innerHTML="","inbox"===this.state.view&&this._renderInbox(),"new"===this.state.view&&this._renderNewConversation(),"conversation"===this.state.view&&this._renderConversation())},a.prototype._renderInbox=function(){var t=this,e=document.createElement("div");e.className="aware-chat-body",e.innerHTML="Cargando conversaciones...",this.container.innerHTML='\n     <div class="aware-chat-header">\n        <div class="aware-chat-header-top">\n          <strong>Mensajes</strong>\n          <button class="aware-btn" id="new-chat">Ôºã</button>\n        </div>\n\n\n     </div>\n   ',this.container.appendChild(e),this.api.getInbox().then(function(a){t.state.inbox.conversations=a,t._renderInboxList(a),t._updateTotalUnread(a),e.innerHTML="",a.length?a.forEach(function(a){var s="";s=a.doctor.id===t.options.currentUserId?a.patient.full_name:a.doctor.full_name;var o=a.unread_count||0,r=i(a.last_message),c=document.createElement("div");c.className="aware-chat-item"+(o>0?" unread":"");var d=a.last_message?n(a.last_message.created_at):"";c.innerHTML=`\n        <div class="aware-chat-item-row">\n          <strong>${s}</strong>\n          <div class="inbox-meta">\n            <span class="inbox-date">${d}</span>\n            ${o>0?`<span class="inbox-badge">${o}</span>`:""}\n          </div>\n        </div>\n        <div class="last-message">${r}</div>\n      `,c.onclick=function(){t.navigate("conversation",a.id,s)},e.appendChild(c)}):e.innerHTML="<p>No hay conversaciones</p>"}).catch(function(t){e.innerHTML="<p>Error cargando inbox</p>",console.error(t)}),this.container.querySelector("#new-chat").onclick=function(){t.navigate("new")}},a.prototype._renderInboxList=function(t){var e=this.container.querySelector(".aware-chat-body");if(e)if(e.innerHTML="",t.length){var a=this;t.forEach(function(t){var s="";s=t.doctor.id===a.options.currentUserId?t.patient.full_name:t.doctor.full_name;var o=i(t.last_message),r=t.last_message?n(t.last_message.created_at):"",c=t.unread_count||0,d=document.createElement("div");d.className="aware-chat-item"+(c>0?" unread":""),d.setAttribute("data-conversation-id",t.id),d.innerHTML=`\n        <div class="aware-chat-item-row">\n          <strong>${s}</strong>\n          <div class="inbox-meta">\n            <span class="inbox-date">${r}</span>\n            ${c>0?`<span class="inbox-badge">${c}</span>`:""}\n          </div>\n        </div>\n        <div class="last-message">${o}</div>\n      `,d.onclick=function(){a.navigate("conversation",t.id,s)},e.appendChild(d)})}else e.innerHTML="<p>No hay resultados</p>"},a.prototype._renderNewConversation=function(){var t=this;this.container.innerHTML='\n      <div class="aware-chat-header">\n        <div class="aware-chat-header-top">\n          <button class="aware-btn" id="back">‚Üê</button>\n          <strong>Nueva conversaci√≥n</strong>\n        </div>\n      </div>\n\n      <div class="aware-chat-body" id="contacts-body">\n        Cargando contactos...\n      </div>\n    ';var e=this.container.querySelector("#contacts-body");this.api.getContacts().then(function(n){e.innerHTML="",n.length?n.forEach(function(n){var i=document.createElement("div");i.className="aware-chat-item",i.innerHTML=`\n            <strong>${n.name}</strong>\n            <div class="last-message">\n              ${"doctor"===n.role?"Doctor":"Paciente"}\n            </div>\n          `,i.onclick=function(){t.api.createConversation(n.id,n.role).then(function(e){t.navigate("conversation",e.id)}).catch(function(t){console.error("Error creando conversaci√≥n",t)})},e.appendChild(i)}):e.innerHTML="<p>No hay contactos disponibles</p>"}).catch(function(t){e.innerHTML="<p>Error cargando contactos</p>",console.error(t)}),this.container.querySelector("#back").onclick=function(){t.navigate("inbox")}},a.prototype._renderConversation=function(){var t=this;this.container.innerHTML=`\n        <div class="aware-chat-header">\n          <div class="aware-chat-header-top">\n            <button class="aware-btn" id="back">‚Üê</button>\n            <strong>${this.state.conversation.receiver}</strong>\n            <div class="aware-chat-header-status">\n              <span\n                class="presence-dot offline"\n                id="presence-dot"\n              ></span>\n              <span id="presence-text">Desconectado</span>\n            </div>\n          </div>\n\n          <div\n            class="aware-chat-header-typing"\n            id="typing-indicator"\n            style="display:none;"\n          >\n            Escribiendo‚Ä¶\n          </div>\n        </div>\n\n        <div class="aware-chat-body" id="chat-body">\n          Cargando mensajes...\n        </div>\n\n        <div\n          class="aware-attachments-preview"\n          id="attachments-preview"\n        ></div>\n\n        <div class="aware-chat-input">\n          <input\n            type="text"\n            id="chat-input"\n            placeholder="Escribe un mensaje‚Ä¶"\n          />\n          <button class="aware-attach-btn" id="attach-btn">üìé</button>\n          <input type="file" id="file-input" multiple style="display:none;" />\n          <button class="aware-send-btn" id="send-btn" title="Enviar">\n            ‚û§\n          </button>\n        </div>\n      `;var e=this.container.querySelector("#chat-body"),n=this.container.querySelector("#attach-btn"),i=this.container.querySelector("#file-input"),a=this.container.querySelector("#chat-input"),s=this.container.querySelector("#send-btn");function o(){if(t.ws.send({type:"typing",is_typing:!1}),!t.isSending){var e=a.value.trim();(e||0!==t.pendingAttachments.length)&&(t.isSending=!0,t.pendingText=e,t.ws.send({type:"message",text:e}),a.value="")}}n.onclick=function(){i.click()},i.onchange=function(){Array.from(i.files).forEach(function(e){t.pendingAttachments.push(e)}),t._renderAttachmentPreviews(),i.value=""},this.api.getMessages(this.state.conversation.id).then(function(n){e.innerHTML="";var i=Object.values(n);i.length?(i.forEach(function(e){t._appendMessage(e)}),e.scrollTop=e.scrollHeight):e.innerHTML="<p>No hay mensajes</p>"}).catch(function(t){e.innerHTML="<p>Error cargando mensajes</p>",console.error(t)}),s.onclick=o,a.onkeydown=function(t){"Enter"===t.key&&o()};var r=null;a.oninput=function(){t.ws.send({type:"typing",is_typing:!0}),clearTimeout(r),r=setTimeout(function(){t.ws.send({type:"typing",is_typing:!1})},1e3)},this.container.querySelector("#back").onclick=function(){t.ws.disconnect(),t.navigate("inbox")},t.ws.disconnect(),t.ws.connect(this.state.conversation.id,{onOpen:function(){t.ws.send({type:"read"})},onMessage:function(e){t._handleWsEvent(e)}}),this.container.onclick=function(e){var n=e.target.closest("[data-image-preview]");n&&t._openImageModal(n.src)}},a.prototype._handleWsEvent=function(t){if("message"===t.type)return"conversation"!==this.state.view&&t.message.sender!==this.options.currentUserId&&(this.totalUnread+=1,this._renderLauncherBadge()),"conversation"!==this.state.view&&this._incrementInboxBadge(t.message.conversation_id),void("conversation"===this.state.view&&this._handleOwnMessageCreated(t.message));"typing"===t.type&&this._handleTyping(t),"presence"===t.type&&this._handlePresence(t),"read"===t.type&&this._handleReadReceipt(t),"attachment"===t.type&&this._appendAttachment(t.message_id,t.attachment)},a.prototype._handleOwnMessageCreated=function(t){if(this._appendMessage(t),this.pendingAttachments.length){var e=t.id,n=this,i=this.pendingAttachments.map(function(t){return n.api.uploadAttachment(e,t)});Promise.all(i).then(function(){n._resetPendingState()}).catch(function(t){console.error("Error subiendo adjuntos",t),n._resetPendingState()})}else this._resetPendingState()},a.prototype._appendMessage=function(t){var e=this.container.querySelector("#chat-body");if(e){var n=t.attachments&&1===t.attachments.length&&t.attachments[0].file_type.startsWith("image")&&!t.text,i=t.sender===this.options.currentUserId,a=document.createElement("div");a.className="aware-message "+(i?"mine":"other")+(n?" image-only":""),a.setAttribute("data-message-id",t.id);var s,o,r=`\n      <div class="message-text">${t.text||""}</div>\n      <div class="message-meta">\n        <span class="message-date">${s=t.created_at,o=new Date(s),o.toLocaleDateString()+" "+o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>\n        ${i?'<span class="message-status">‚úì</span>':""}\n      </div>\n    `;t.attachments&&t.attachments.length&&t.attachments.forEach(function(t){if(t.file_type.startsWith("image"))r+=`\n            <img src="${t.file}" class="chat-image" data-image-preview />\n          `;else{var e=t.file.split("/").pop();r+=`\n            <div class="chat-attachment chat-attachment-pdf">\n              <div class="chat-attachment-icon">üìÑ</div>\n              <div class="chat-attachment-info">\n                <div class="chat-attachment-name">${e}</div>\n                <div class="chat-attachment-meta">\n                  ${(t.file_size/1024).toFixed(0)} KB\n                </div>\n                <a\n                  href="${t.file}"\n                  target="_blank"\n                  class="chat-attachment-link"\n                >\n                  Descargar\n                </a>\n              </div>\n            </div>\n          `}}),a.innerHTML=r,e.appendChild(a),e.scrollTop=e.scrollHeight}},a.prototype._appendAttachment=function(t,e){var n=this.container.querySelector('[data-message-id="'+t+'"]');if(n)if(e.file_type.startsWith("image"))n.innerHTML+=`\n        <img src="${e.file}" class="chat-image" />\n      `;else{var i=e.file.split("/").pop();n.innerHTML+=`\n        <div class="chat-attachment chat-attachment-pdf">\n          <div class="chat-attachment-icon">üìÑ</div>\n          <div class="chat-attachment-info">\n            <div class="chat-attachment-name">${i}</div>\n            <div class="chat-attachment-meta">\n              ${(e.file_size/1024).toFixed(0)} KB\n            </div>\n            <a\n              href="${e.file}"\n              target="_blank"\n              class="chat-attachment-link"\n            >\n              Descargar\n            </a>\n          </div>\n        </div>\n      `}},a.prototype._renderAttachmentPreviews=function(){var t=this.container.querySelector("#attachments-preview");if(t){t.innerHTML="";var e=this;this.pendingAttachments.forEach(function(n,i){var a=document.createElement("div");if(a.className="attachment-preview",n.type.startsWith("image")){var s=document.createElement("img");s.src=URL.createObjectURL(n),a.appendChild(s)}else a.innerHTML+=`\n          üìÑ ${n.name} (${(n.size/1024).toFixed(0)} KB)\n        `;var o=document.createElement("span");o.className="remove",o.innerText="‚úñ",o.onclick=function(){e.pendingAttachments.splice(i,1),e._renderAttachmentPreviews()},a.appendChild(o),t.appendChild(a)})}},a.prototype._handleTyping=function(t){if(console.log(this.options.isDoctor),t.sender_role!==(this.options.isDoctor?"doctor":"patient")){var e=this.container.querySelector("#typing-indicator");e&&(t.is_typing?(e.style.display="block",e.innerText="Escribiendo..."):e.style.display="none")}},a.prototype._handlePresence=function(t){if(t.user_id!==this.options.currentUserId){var e=this.container.querySelector("#presence-dot"),n=this.container.querySelector("#presence-text");e&&n&&(t.is_online?(e.classList.remove("offline"),e.classList.add("online"),n.innerText="En linea"):(e.classList.remove("online"),e.classList.add("offline"),n.innerText="Desconectado"))}},a.prototype._handleReadReceipt=function(t){this.container.querySelectorAll(".message-status").forEach(function(t){t.innerText="‚úì‚úì"})},a.prototype._updateTotalUnread=function(t){var e=0;t.forEach(function(t){e+=t.unread_count||0}),this.totalUnread=e,this._renderLauncherBadge()},a.prototype._renderLauncherBadge=function(){if(this.launcher){var t=this.launcher.querySelector("#launcher-badge");t&&(this.totalUnread>0?(t.innerText=this.totalUnread,t.classList.remove("hidden")):t.classList.add("hidden"))}},a.prototype._incrementInboxBadge=function(t){var e=this.container.querySelector('[data-conversation-id="'+t+'"]');if(e){var n=e.querySelector(".inbox-badge");if(n)n.innerText=parseInt(n.innerText,10)+1;else{var i=e.querySelector(".inbox-meta"),a=document.createElement("span");a.className="inbox-badge",a.innerText="1",i.appendChild(a)}}},a.prototype._clearInboxBadge=function(t){var e=this.container.querySelector('[data-conversation-id="'+t+'"]');if(e){var n=e.querySelector(".inbox-badge");n&&n.remove()}},a.prototype._resetPendingState=function(){this.pendingAttachments=[],this.pendingText="",this.pendingMessageId=null,this.isSending=!1;var t=this.container.querySelector("#attachments-preview");t&&(t.innerHTML="")},a.prototype._resetWidget=function(){this.ws&&this.ws.disconnect(),this.state.view="inbox",this.state.conversation.id=null,this.state.conversation.receiver=null,this.state.conversation.messages=[],this.pendingAttachments=[],this.pendingText="",this.pendingMessageId=null,this.isSending=!1,this.container&&(this.container.innerHTML="")},"undefined"!=typeof window&&(window.ChatWidget=a),a}();
