/*!
 * LuisByt Chat Widget v1.0.12
 * https://github.com/luis-byt/chat-widget
 * ¬© 2025 Byt
 * MIT License
 */
var ChatWidget=function(){"use strict";function e(e){this.baseUrl=e.apiBaseUrl,this.token=e.token,this.endpoints=e.endpoints||{}}function t(e){this.wsBaseUrl=e.wsBaseUrl,this.token=e.token,this.socket=null}function n(e){if(!e)return"";var t=new Date(e),n=new Date,a=new Date(n.getFullYear(),n.getMonth(),n.getDate()),i=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=Math.floor((a-i)/864e5);return 0===s?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):1===s?"Ayer":t.toLocaleDateString()}function a(e){if(!e)return"Sin mensajes";if(e.attachments&&e.attachments.length>0){const t=e.attachments.length;return 1===t?"1 Adjunto":`${t} Adjuntos`}if(e.text){const t=e.text.trim();return t.length>40?t.slice(0,40)+"‚Ä¶":t}return"Mensaje"}function i(n){this.options=n||{},this.closeOnOutsideClick=!!this.options.closeOnOutsideClick,this.options.position=n.position||"bottom-right",this.api=new e(n),this.ws=new t(n),this.state={isOpen:!1,view:"inbox",inbox:{loading:!1,conversations:[]},contacts:{loading:!1,list:[]},conversation:{id:null,receiver:null,messages:[],loading:!1}},this.launcher=null,this.container=null,this.pendingAttachments=[],this.pendingText="",this.pendingMessageId=null,this.isSending=!1,this.totalUnread=0}return e.prototype.request=function(e,t,n){return fetch(this.baseUrl+e,{method:t||"GET",headers:{"Content-Type":"application/json",Authorization:"JWT "+this.token},body:n?JSON.stringify(n):null}).then(function(e){if(!e.ok)throw new Error("API error");return e.json()})},e.prototype.getInbox=function(){return this.request(this.endpoints.inbox)},e.prototype.getContacts=function(){return this.request(this.endpoints.contacts)},e.prototype.createConversation=function(e,t){return this.request(this.endpoints.createConversation,"POST",{contact_id:e,contact_role:t})},e.prototype.getMessages=function(e){return this.request(this.endpoints.messages(e))},e.prototype.getMessage=function(e){return this.request(this.endpoints.message(e))},e.prototype.uploadAttachment=function(e,t){var n=new FormData;return n.append("file",t),fetch(this.baseUrl+this.endpoints.uploadAttachment(e),{method:"POST",headers:{Authorization:"JWT "+this.token},body:n}).then(function(e){if(!e.ok)throw new Error("Upload failed");return e.json()})},t.prototype.connect=function(e,t){var n=this.wsBaseUrl+"/ws/chat/"+e+"/?token="+this.token;this.socket=new WebSocket(n),this.socket.onopen=function(){t.onOpen&&t.onOpen()},this.socket.onmessage=function(e){var n=JSON.parse(e.data);t.onMessage&&t.onMessage(n)},this.socket.onclose=function(){t.onClose&&t.onClose()},this.socket.onerror=function(e){console.error("WS error",e)}},t.prototype.send=function(e){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send(JSON.stringify(e))},t.prototype.disconnect=function(){this.socket&&(this.socket.close(),this.socket=null)},i.prototype.mount=function(){this._createLauncher(),this._createWidget(),this._initGlobalReactionClose(),this._render()},i.prototype._createLauncher=function(){var e=document.createElement("div");e.className="aware-chat-launcher position-"+this.options.position,e.innerHTML=`\n      <i class="${this.options.logo}"></i>\n      <span class="launcher-badge hidden" id="launcher-badge"></span>\n    `;var t=this.options.primaryColor||"#0d6efd";e.style.setProperty("--aware-primary",t),e.onclick=function(e){e.stopPropagation(),this.toggle()}.bind(this),document.body.appendChild(e),this.launcher=e},i.prototype._createWidget=function(){var e=document.createElement("div");e.className="aware-chat-widget hidden position-"+this.options.position;var t=this.options.primaryColor||"#0d6efd";e.style.setProperty("--aware-primary",t),e.addEventListener("click",function(e){e.stopPropagation()}),document.body.appendChild(e),this.container=e,this._createImageModal()},i.prototype._syncWidgetPosition=function(){if(this.launcher&&this.container){var e=this.launcher.getBoundingClientRect();this.container.offsetWidth;var t=window.innerWidth;this.container.style.bottom=window.innerHeight-e.top+12+"px",this.container.style.top="auto",this.container.style.left="auto",this.container.style.right="auto",this.container.style.transform="none";var n=e.left+e.width/2;n<.33*t?this.container.style.left=e.left+"px":n>.66*t?this.container.style.right=t-e.right+"px":(this.container.style.left=n+"px",this.container.style.transform="translateX(-50%)")}},i.prototype._createImageModal=function(){var e=document.createElement("div");e.className="aware-image-modal hidden",e.innerHTML='\n      <div class="aware-image-modal-backdrop"></div>\n      <div class="aware-image-modal-content">\n        <img src="" alt="Preview" />\n        <button class="aware-image-modal-close">‚úï</button>\n      </div>\n    ',document.body.appendChild(e),this.imageModal=e;var t=this;e.querySelector(".aware-image-modal-backdrop").onclick=function(e){e.stopPropagation(),t._closeImageModal()},e.querySelector(".aware-image-modal-content").onclick=function(e){e.stopPropagation()},e.querySelector(".aware-image-modal-close").onclick=function(e){e.stopPropagation(),t._closeImageModal()},document.addEventListener("keydown",function(e){"Escape"===e.key&&(e.stopPropagation(),t._closeImageModal())})},i.prototype._openImageModal=function(e){this.imageModal&&(this.imageModal.querySelector("img").src=e,setTimeout(()=>{this.imageModal.classList.remove("hidden")},0))},i.prototype._closeImageModal=function(){this.imageModal&&(this.imageModal.querySelector("img").src="",this.imageModal.classList.add("hidden"))},i.prototype.toggle=function(){if(this.state.isOpen=!this.state.isOpen,!this.state.isOpen)return this.container.classList.add("hidden"),this.closeOnOutsideClick&&document.removeEventListener("click",this._outsideClickHandler),void this._resetWidget();this.container.classList.remove("hidden"),this._syncWidgetPosition(),this.state.view="inbox",this._render(),this.closeOnOutsideClick&&(this._outsideClickHandler=this._outsideClickHandler||this._handleOutsideClick.bind(this),document.addEventListener("click",this._outsideClickHandler))},i.prototype.navigate=function(e,t,n){if(this.state.view=e,this.state.conversation.id=t||null,this.state.conversation.receiver=n||null,"conversation"===e&&t){var a=this.state.inbox.conversations.find(e=>e.id===t);a&&a.unread_count&&(this.totalUnread-=a.unread_count,a.unread_count=0,this._renderLauncherBadge()),this._clearInboxBadge(t)}this._render()},i.prototype._handleOutsideClick=function(e){this.state.isOpen&&(this.container.contains(e.target)||this.launcher.contains(e.target)||this.toggle())},i.prototype._render=function(){this.container&&(this.container.innerHTML="","inbox"===this.state.view&&this._renderInbox(),"new"===this.state.view&&this._renderNewConversation(),"conversation"===this.state.view&&this._renderConversation())},i.prototype._renderInbox=function(){var e=this,t=document.createElement("div");t.className="aware-chat-body",t.innerHTML="Cargando conversaciones...",this.container.innerHTML='\n      <div class="aware-chat-header">\n        <div class="aware-chat-header-top">\n          <strong>Conversaciones</strong>\n          <button class="aware-btn" id="new-chat">Ôºã</button>\n        </div>\n\n        <div class="aware-chat-search">\n          <span class="search-icon">üîç</span>\n          <input\n            type="text"\n            id="inbox-search"\n            placeholder="Buscar una conversaci√≥n..."\n          />\n        </div>\n     </div>\n   ',this.container.appendChild(t),this.api.getInbox().then(function(i){e.state.inbox.conversations=i,e._renderInboxList(i),e._updateTotalUnread(i),t.innerHTML="",i.length?i.forEach(function(i){var s="";s=i.doctor.id===e.options.currentUserId?i.patient.full_name:i.doctor.full_name;var o=i.unread_count||0,r=a(i.last_message),c=document.createElement("div");c.className="aware-chat-item"+(o>0?" unread":"");var d=i.last_message?n(i.last_message.created_at):"";c.innerHTML=`\n          <div class="aware-chat-item-row">\n            <strong>${s}</strong>\n            <div class="inbox-meta">\n              <span class="inbox-date">${d}</span>\n              ${o>0?`<span class="inbox-badge">${o}</span>`:""}\n            </div>\n          </div>\n          <div class="last-message">${r}</div>\n        `,c.onclick=function(){e.navigate("conversation",i.id,s)},t.appendChild(c)}):t.innerHTML="<p>No hay conversaciones</p>"}).catch(function(e){t.innerHTML="<p>Error cargando inbox</p>",console.error(e)}),this.container.querySelector("#new-chat").onclick=function(){e.navigate("new")};var i=this.container.querySelector("#inbox-search");i.oninput=function(){var t=i.value.toLowerCase().trim(),n=e.state.inbox.conversations.filter(function(n){var a=n.doctor.id===e.options.currentUserId?n.patient.full_name:n.doctor.full_name,i=n.last_message?n.last_message.text:"";return a.toLowerCase().includes(t)||i.toLowerCase().includes(t)});e._renderInboxList(n)}},i.prototype._renderInboxList=function(e){var t=this.container.querySelector(".aware-chat-body");if(t)if(t.innerHTML="",e.length){var i=this;e.forEach(function(e){var s="";s=e.doctor.id===i.options.currentUserId?e.patient.full_name:e.doctor.full_name;var o=a(e.last_message),r=e.last_message?n(e.last_message.created_at):"",c=e.unread_count||0,d=document.createElement("div");d.className="aware-chat-item"+(c>0?" unread":""),d.setAttribute("data-conversation-id",e.id),d.innerHTML=`\n        <div class="aware-chat-item-row">\n          <strong>${s}</strong>\n          <div class="inbox-meta">\n            <span class="inbox-date">${r}</span>\n            ${c>0?`<span class="inbox-badge">${c}</span>`:""}\n          </div>\n        </div>\n        <div class="last-message">${o}</div>\n      `,d.onclick=function(){i.navigate("conversation",e.id,s)},t.appendChild(d)})}else t.innerHTML="<p>No hay resultados</p>"},i.prototype._renderNewConversation=function(){var e=this;this.container.innerHTML='\n      <div class="aware-chat-header">\n        <div class="aware-chat-header-top">\n          <button class="aware-btn" id="back">‚Üê</button>\n          <strong>Nueva conversaci√≥n</strong>\n        </div>\n  \n        <div class="aware-chat-search">\n          <span class="search-icon">üîç</span>\n          <input\n            type="text"\n            id="contacts-search"\n            placeholder="Buscar contacto e inicia una conversaci√≥n"\n          />\n        </div>\n      </div>\n  \n      <div class="aware-chat-body" id="contacts-body">\n        Cargando contactos...\n      </div>\n    ';var t=this.container.querySelector("#contacts-body");this.api.getContacts().then(function(n){e.state.contacts.list=n;var a=e.container.querySelector("#contacts-search");function i(n){t.innerHTML="",n.length?n.forEach(function(n){var a=document.createElement("div");a.className="aware-chat-item",a.innerHTML=`\n              <strong>${n.name}</strong>\n              <div class="last-message">\n                ${"doctor"===n.role?"Doctor":"Paciente"}\n              </div>\n            `,a.onclick=function(){e.api.createConversation(n.id,n.role).then(function(t){e.navigate("conversation",t.id)}).catch(console.error)},t.appendChild(a)}):t.innerHTML="<p>No hay contactos disponibles</p>"}a.oninput=function(){var t=a.value.toLowerCase().trim();i(e.state.contacts.list.filter(function(e){return e.name.toLowerCase().includes(t)}))},i(n)}).catch(function(e){t.innerHTML="<p>Error cargando contactos</p>",console.error(e)}),this.container.querySelector("#back").onclick=function(){e.navigate("inbox")}},i.prototype._renderConversation=function(){var e=this;this.container.innerHTML=`\n      <div class="aware-chat-header">\n        <div class="aware-chat-header-top">\n          <button class="aware-btn" id="back">‚Üê</button>\n          <strong>${this.state.conversation.receiver}</strong>\n          <div class="aware-chat-header-status">\n            <span\n              class="presence-dot offline"\n              id="presence-dot"\n            ></span>\n            <span id="presence-text">Desconectado</span>\n          </div>\n        </div>\n\n        <div\n          class="aware-chat-header-typing"\n          id="typing-indicator"\n          style="display:none;"\n        >\n          Escribiendo‚Ä¶\n        </div>\n      </div>\n\n      <div class="aware-chat-body" id="chat-body">\n        Cargando mensajes...\n      </div>\n\n      <div\n        class="aware-attachments-preview"\n        id="attachments-preview"\n      ></div>\n\n      <div class="aware-chat-input">\n        <input\n          type="text"\n          id="chat-input"\n          placeholder="Escribe un mensaje‚Ä¶"\n        />\n        <button class="aware-attach-btn" id="attach-btn">üìé</button>\n        <input type="file" id="file-input" multiple style="display:none;" />\n        <button class="aware-send-btn" id="send-btn" title="Enviar">\n          ‚û§\n        </button>\n      </div>\n    `;var t=this.container.querySelector("#chat-body"),n=this.container.querySelector("#attach-btn"),a=this.container.querySelector("#file-input"),i=this.container.querySelector("#chat-input"),s=this.container.querySelector("#send-btn");function o(){if(e.ws.send({type:"typing",is_typing:!1}),!e.isSending){var t=i.value.trim();(t||0!==e.pendingAttachments.length)&&(e.isSending=!0,e.pendingText=t,e.ws.send({type:"message",text:t}),i.value="")}}n.onclick=function(){a.click()},a.onchange=function(){Array.from(a.files).forEach(function(t){e.pendingAttachments.push(t)}),e._renderAttachmentPreviews(),a.value=""},this.api.getMessages(this.state.conversation.id).then(function(n){t.innerHTML="";var a=Object.values(n);a.length?(a.forEach(function(t){e._appendMessage(t)}),t.scrollTop=t.scrollHeight):t.innerHTML='<p class="no-messages">No hay mensajes</p>'}).catch(function(e){t.innerHTML="<p>Error cargando mensajes</p>",console.error(e)}),s.onclick=o,i.onkeydown=function(e){"Enter"===e.key&&o()};var r=null;i.oninput=function(){e.ws.send({type:"typing",is_typing:!0}),clearTimeout(r),r=setTimeout(function(){e.ws.send({type:"typing",is_typing:!1})},1e3)},this.container.querySelector("#back").onclick=function(){e.ws.disconnect(),e.navigate("inbox")},e.ws.disconnect(),e.ws.connect(this.state.conversation.id,{onOpen:function(){e.ws.send({type:"read"})},onMessage:function(t){e._handleWsEvent(t)}}),this.container.onclick=function(t){var n=t.target.closest("[data-image-preview]");n&&e._openImageModal(n.src)}},i.prototype._handleWsEvent=function(e){if("message"===e.type)return"conversation"!==this.state.view&&e.message.sender!==this.options.currentUserId&&(this.totalUnread+=1,this._renderLauncherBadge()),"conversation"!==this.state.view&&this._incrementInboxBadge(e.message.conversation_id),void("conversation"===this.state.view&&this._handleOwnMessageCreated(e.message));"typing"===e.type&&this._handleTyping(e),"presence"===e.type&&this._handlePresence(e),"read"===e.type&&this._handleReadReceipt(e),"attachment"===e.type&&this._appendAttachment(e.message_id,e.attachment),"reaction"===e.type&&this._refreshMessageReactions(e.message_id)},i.prototype._handleOwnMessageCreated=function(e){if(this._appendMessage(e),this.pendingAttachments.length){var t=e.id,n=this,a=this.pendingAttachments.map(function(e){return n.api.uploadAttachment(t,e)});Promise.all(a).then(function(){n._resetPendingState()}).catch(function(e){console.error("Error subiendo adjuntos",e),n._resetPendingState()})}else this._resetPendingState()},i.prototype._appendMessage=function(e){var t=this.container.querySelector("#chat-body");if(t){var n=t.querySelector(".no-messages");n&&n.remove();var a=e.sender===this.options.currentUserId,i=e.attachments&&1===e.attachments.length&&e.attachments[0].file_type.startsWith("image")&&!e.text,s=document.createElement("div");s.className="message-row "+(a?"mine":"other");var o=document.createElement("div");o.className="message-actions",o.innerHTML='<button class="reaction-btn" title="Reaccionar">üòä</button>';var r=document.createElement("div");r.className="aware-message "+(a?"mine":"other")+(i?" image-only":""),r.setAttribute("data-message-id",e.id);var c,d,l=`\n      <div class="message-text">${e.text.trim()||""}</div>\n      <div class="message-meta">\n        <span class="message-date">${c=e.created_at,d=new Date(c),d.toLocaleDateString()+" "+d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>\n        ${a?'<span class="message-status">‚úì</span>':""}\n      </div>\n    `;e.attachments&&e.attachments.length&&e.attachments.forEach(function(e){if(e.file_type.startsWith("image"))l+=`<img src="${e.file}" class="chat-image" data-image-preview />`;else{var t=e.file.split("/").pop();l+=`\n            <div class="chat-attachment chat-attachment-pdf">\n              <div class="chat-attachment-icon">üìÑ</div>\n              <div class="chat-attachment-info">\n                <div class="chat-attachment-name">${t}</div>\n                <div class="chat-attachment-meta">\n                  ${(e.file_size/1024).toFixed(0)} KB\n                </div>\n                <a href="${e.file}" target="_blank" class="chat-attachment-link">\n                  Descargar\n                </a>\n              </div>\n            </div>\n          `}}),e.reactions&&e.reactions.length&&(l+='<div class="message-reactions">',e.reactions.forEach(e=>{l+=`<span class="reaction">${e.reaction} ${e.count}</span>`}),l+="</div>"),r.innerHTML=l;var h=document.createElement("div");h.className="reaction-menu hidden",h.innerHTML="\n      <span>üëç</span>\n      <span>‚ù§Ô∏è</span>\n      <span>üòÇ</span>\n      <span>üòÆ</span>\n      <span>üò¢</span>\n      <span>üôèüèª</span>\n    ",a?(s.appendChild(o),s.appendChild(r)):(s.appendChild(r),s.appendChild(o)),s.appendChild(h),t.appendChild(s),s.querySelectorAll("[data-image-preview]").forEach(e=>{e.onclick=t=>{t.stopPropagation(),this._openImageModal(e.src)}}),o.querySelector(".reaction-btn").onclick=e=>{e.stopPropagation(),document.querySelectorAll(".reaction-menu:not(.hidden)").forEach(e=>{e!==h&&e.classList.add("hidden")}),h.classList.toggle("hidden")},h.onclick=e=>{e.stopPropagation()},h.querySelectorAll("span").forEach(t=>{t.onclick=()=>{this.ws.send({type:"reaction",message_id:e.id,reaction:t.innerText}),h.classList.add("hidden")}}),t.scrollTop=t.scrollHeight}},i.prototype._appendAttachment=function(e,t){var n=this.container.querySelector('[data-message-id="'+e+'"]');if(n)if(t.file_type.startsWith("image"))n.innerHTML+=`\n        <img src="${t.file}" class="chat-image" data-image-preview  />\n      `;else{var a=t.file.split("/").pop();n.innerHTML+=`\n        <div class="chat-attachment chat-attachment-pdf">\n          <div class="chat-attachment-icon">üìÑ</div>\n          <div class="chat-attachment-info">\n            <div class="chat-attachment-name">${a}</div>\n            <div class="chat-attachment-meta">\n              ${(t.file_size/1024).toFixed(0)} KB\n            </div>\n            <a\n              href="${t.file}"\n              target="_blank"\n              class="chat-attachment-link"\n            >\n              Descargar\n            </a>\n          </div>\n        </div>\n      `}},i.prototype._renderAttachmentPreviews=function(){var e=this.container.querySelector("#attachments-preview");if(e){e.innerHTML="";var t=this;this.pendingAttachments.forEach(function(n,a){var i=document.createElement("div");if(i.className="attachment-preview",n.type.startsWith("image")){var s=document.createElement("img");s.src=URL.createObjectURL(n),i.appendChild(s)}else i.innerHTML+=`\n          üìÑ ${n.name} (${(n.size/1024).toFixed(0)} KB)\n        `;var o=document.createElement("span");o.className="remove",o.innerText="‚úñ",o.onclick=function(){t.pendingAttachments.splice(a,1),t._renderAttachmentPreviews()},i.appendChild(o),e.appendChild(i)})}},i.prototype._refreshMessageReactions=function(e){var t=this;this.api.getMessage(e).then(function(n){var a=t.container.querySelector('[data-message-id="'+e+'"]');if(a){var i=a.querySelector(".message-reactions");if(i&&i.remove(),n.reactions&&n.reactions.length){var s=document.createElement("div");s.className="message-reactions",n.reactions.forEach(function(e){var t=document.createElement("span");t.className="reaction",t.innerText=e.reaction+" "+e.count,s.appendChild(t)}),a.appendChild(s)}}}).catch(function(e){console.error("Error refrescando reacciones",e)})},i.prototype._initGlobalReactionClose=function(){document.addEventListener("click",function(){document.querySelectorAll(".reaction-menu:not(.hidden)").forEach(e=>{e.classList.add("hidden")})})},i.prototype._handleTyping=function(e){if(e.sender_role!==(this.options.isDoctor?"doctor":"patient")){var t=this.container.querySelector("#typing-indicator");t&&(e.is_typing?(t.style.display="block",t.innerText="Escribiendo..."):t.style.display="none")}},i.prototype._handlePresence=function(e){if(e.user_id!==this.options.currentUserId){var t=this.container.querySelector("#presence-dot"),n=this.container.querySelector("#presence-text");t&&n&&(e.is_online?(t.classList.remove("offline"),t.classList.add("online"),n.innerText="En linea"):(t.classList.remove("online"),t.classList.add("offline"),n.innerText="Desconectado"))}},i.prototype._handleReadReceipt=function(e){this.container.querySelectorAll(".message-status").forEach(function(e){e.innerText="‚úì‚úì"})},i.prototype._updateTotalUnread=function(e){var t=0;e.forEach(function(e){t+=e.unread_count||0}),this.totalUnread=t,this._renderLauncherBadge()},i.prototype._renderLauncherBadge=function(){if(this.launcher){var e=this.launcher.querySelector("#launcher-badge");e&&(this.totalUnread>0?(e.innerText=this.totalUnread,e.classList.remove("hidden")):e.classList.add("hidden"))}},i.prototype._incrementInboxBadge=function(e){var t=this.container.querySelector('[data-conversation-id="'+e+'"]');if(t){var n=t.querySelector(".inbox-badge");if(n)n.innerText=parseInt(n.innerText,10)+1;else{var a=t.querySelector(".inbox-meta"),i=document.createElement("span");i.className="inbox-badge",i.innerText="1",a.appendChild(i)}}},i.prototype._clearInboxBadge=function(e){var t=this.container.querySelector('[data-conversation-id="'+e+'"]');if(t){var n=t.querySelector(".inbox-badge");n&&n.remove()}},i.prototype._resetPendingState=function(){this.pendingAttachments=[],this.pendingText="",this.pendingMessageId=null,this.isSending=!1;var e=this.container.querySelector("#attachments-preview");e&&(e.innerHTML="")},i.prototype._resetWidget=function(){this.ws&&this.ws.disconnect(),this.state.view="inbox",this.state.conversation.id=null,this.state.conversation.receiver=null,this.state.conversation.messages=[],this.pendingAttachments=[],this.pendingText="",this.pendingMessageId=null,this.isSending=!1,this.container&&(this.container.innerHTML="")},"undefined"!=typeof window&&(window.ChatWidget=i),i}();
