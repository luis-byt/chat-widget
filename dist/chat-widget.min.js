/*!
 * LuisByt Chat Widget v1.0.6
 * https://github.com/luis-byt/chat-widget
 * ¬© 2025 Byt
 * MIT License
 */
var ChatWidget=function(){"use strict";function e(e){this.baseUrl=e.apiBaseUrl,this.token=e.token,this.endpoints=e.endpoints||{}}function t(e){this.wsBaseUrl=e.wsBaseUrl,this.token=e.token,this.socket=null}function n(e){if(!e)return"";var t=new Date(e),n=new Date,i=new Date(n.getFullYear(),n.getMonth(),n.getDate()),a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=Math.floor((i-a)/864e5);return 0===s?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):1===s?"Ayer":t.toLocaleDateString()}function i(e){if(!e)return"Sin mensajes";if(e.attachments&&e.attachments.length>0){const t=e.attachments.length;return 1===t?"1 Adjunto":`${t} Adjuntos`}if(e.text){const t=e.text.trim();return t.length>40?t.slice(0,40)+"‚Ä¶":t}return"Mensaje"}function a(n){this.options=n||{},this.api=new e(n),this.ws=new t(n),this.state={isOpen:!1,view:"inbox",inbox:{loading:!1,conversations:[]},contacts:{loading:!1,list:[]},conversation:{id:null,receiver:null,messages:[],loading:!1}},this.launcher=null,this.container=null,this.pendingAttachments=[],this.pendingText="",this.pendingMessageId=null,this.isSending=!1,this.totalUnread=0,this.closeOnOutsideClick=!!this.options.closeOnOutsideClick}return e.prototype.request=function(e,t,n){return fetch(this.baseUrl+e,{method:t||"GET",headers:{"Content-Type":"application/json",Authorization:"JWT "+this.token},body:n?JSON.stringify(n):null}).then(function(e){if(!e.ok)throw new Error("API error");return e.json()})},e.prototype.getInbox=function(){return this.request(this.endpoints.inbox)},e.prototype.getContacts=function(){return this.request(this.endpoints.contacts)},e.prototype.createConversation=function(e,t){return this.request(this.endpoints.createConversation,"POST",{contact_id:e,contact_role:t})},e.prototype.getMessages=function(e){return this.request(this.endpoints.messages(e))},e.prototype.uploadAttachment=function(e,t){var n=new FormData;return n.append("file",t),fetch(this.baseUrl+this.endpoints.uploadAttachment(e),{method:"POST",headers:{Authorization:"JWT "+this.token},body:n}).then(function(e){if(!e.ok)throw new Error("Upload failed");return e.json()})},t.prototype.connect=function(e,t){var n=this.wsBaseUrl+"/ws/chat/"+e+"/?token="+this.token;this.socket=new WebSocket(n),this.socket.onopen=function(){t.onOpen&&t.onOpen()},this.socket.onmessage=function(e){var n=JSON.parse(e.data);t.onMessage&&t.onMessage(n)},this.socket.onclose=function(){t.onClose&&t.onClose()},this.socket.onerror=function(e){console.error("WS error",e)}},t.prototype.send=function(e){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send(JSON.stringify(e))},t.prototype.disconnect=function(){this.socket&&(this.socket.close(),this.socket=null)},a.prototype.mount=function(){this._createLauncher(),this._createWidget(),this._render()},a.prototype._createLauncher=function(){var e=document.createElement("div");e.className="aware-chat-launcher",e.innerHTML=`\n      <i class="${this.options.logo}"></i>\n      <span class="launcher-badge hidden" id="launcher-badge"></span>\n    `;var t=this.options.primaryColor||"#0d6efd";e.style.setProperty("--aware-primary",t),e.onclick=function(e){e.stopPropagation(),this.toggle()}.bind(this),document.body.appendChild(e),this.launcher=e},a.prototype._createWidget=function(){var e=document.createElement("div");e.className="aware-chat-widget hidden";var t=this.options.primaryColor||"#0d6efd";e.style.setProperty("--aware-primary",t),e.addEventListener("click",function(e){e.stopPropagation()}),document.body.appendChild(e),this.container=e},a.prototype.toggle=function(){if(this.state.isOpen=!this.state.isOpen,!this.state.isOpen)return this.container.classList.add("hidden"),this.closeOnOutsideClick&&document.removeEventListener("click",this._outsideClickHandler),void this._resetWidget();this.container.classList.remove("hidden"),this.state.view="inbox",this._render(),this.closeOnOutsideClick&&(this._outsideClickHandler=this._outsideClickHandler||this._handleOutsideClick.bind(this),document.addEventListener("click",this._outsideClickHandler))},a.prototype.navigate=function(e,t,n){if(this.state.view=e,this.state.conversation.id=t||null,this.state.conversation.receiver=n||null,"conversation"===e&&t){var i=this.state.inbox.conversations.find(e=>e.id===t);i&&i.unread_count&&(this.totalUnread-=i.unread_count,i.unread_count=0,this._renderLauncherBadge()),this._clearInboxBadge(t)}this._render()},a.prototype._handleOutsideClick=function(e){this.state.isOpen&&(this.container.contains(e.target)||this.launcher.contains(e.target)||this.toggle())},a.prototype._render=function(){this.container&&(this.container.innerHTML="","inbox"===this.state.view&&this._renderInbox(),"new"===this.state.view&&this._renderNewConversation(),"conversation"===this.state.view&&this._renderConversation())},a.prototype._renderInbox=function(){var e=this,t=document.createElement("div");t.className="aware-chat-body",t.innerHTML="Cargando conversaciones...",this.container.innerHTML='\n     <div class="aware-chat-header">\n        <div class="aware-chat-header-top">\n          <strong>Mensajes</strong>\n          <button class="aware-btn" id="new-chat">Ôºã</button>\n        </div>\n\n\n     </div>\n   ',this.container.appendChild(t),this.api.getInbox().then(function(a){e.state.inbox.conversations=a,e._renderInboxList(a),e._updateTotalUnread(a),t.innerHTML="",a.length?a.forEach(function(a){var s="";s=a.doctor.id===e.options.currentUserId?a.patient.full_name:a.doctor.full_name;var o=a.unread_count||0,r=i(a.last_message),c=document.createElement("div");c.className="aware-chat-item"+(o>0?" unread":"");var d=a.last_message?n(a.last_message.created_at):"";c.innerHTML=`\n        <div class="aware-chat-item-row">\n          <strong>${s}</strong>\n          <div class="inbox-meta">\n            <span class="inbox-date">${d}</span>\n            ${o>0?`<span class="inbox-badge">${o}</span>`:""}\n          </div>\n        </div>\n        <div class="last-message">${r}</div>\n      `,c.onclick=function(){e.navigate("conversation",a.id,s)},t.appendChild(c)}):t.innerHTML="<p>No hay conversaciones</p>"}).catch(function(e){t.innerHTML="<p>Error cargando inbox</p>",console.error(e)}),this.container.querySelector("#new-chat").onclick=function(){e.navigate("new")}},a.prototype._renderInboxList=function(e){var t=this.container.querySelector(".aware-chat-body");if(t)if(t.innerHTML="",e.length){var a=this;e.forEach(function(e){var s="";s=e.doctor.id===a.options.currentUserId?e.patient.full_name:e.doctor.full_name;var o=i(e.last_message),r=e.last_message?n(e.last_message.created_at):"",c=e.unread_count||0,d=document.createElement("div");d.className="aware-chat-item"+(c>0?" unread":""),d.setAttribute("data-conversation-id",e.id),d.innerHTML=`\n        <div class="aware-chat-item-row">\n          <strong>${s}</strong>\n          <div class="inbox-meta">\n            <span class="inbox-date">${r}</span>\n            ${c>0?`<span class="inbox-badge">${c}</span>`:""}\n          </div>\n        </div>\n        <div class="last-message">${o}</div>\n      `,d.onclick=function(){a.navigate("conversation",e.id,s)},t.appendChild(d)})}else t.innerHTML="<p>No hay resultados</p>"},a.prototype._renderNewConversation=function(){var e=this;this.container.innerHTML='\n      <div class="aware-chat-header">\n        <button class="aware-btn" id="back">‚Üê</button>\n        <strong>Nueva conversaci√≥n</strong>\n      </div>\n\n      <div class="aware-chat-body" id="contacts-body">\n        Cargando contactos...\n      </div>\n    ';var t=this.container.querySelector("#contacts-body");this.api.getContacts().then(function(n){t.innerHTML="",n.length?n.forEach(function(n){var i=document.createElement("div");i.className="aware-chat-item",i.innerHTML=`\n            <strong>${n.name}</strong>\n            <div class="last-message">\n              ${"doctor"===n.role?"Doctor":"Paciente"}\n            </div>\n          `,i.onclick=function(){e.api.createConversation(n.id,n.role).then(function(t){e.navigate("conversation",t.id)}).catch(function(e){console.error("Error creando conversaci√≥n",e)})},t.appendChild(i)}):t.innerHTML="<p>No hay contactos disponibles</p>"}).catch(function(e){t.innerHTML="<p>Error cargando contactos</p>",console.error(e)}),this.container.querySelector("#back").onclick=function(){e.navigate("inbox")}},a.prototype._renderConversation=function(){var e=this;this.container.innerHTML=`\n        <div class="aware-chat-header">\n          <div class="aware-chat-header-top">\n            <button class="aware-btn" id="back">‚Üê</button>\n            <strong>${this.state.conversation.receiver}</strong>\n            <div class="aware-chat-header-status">\n              <span\n                class="presence-dot offline"\n                id="presence-dot"\n              ></span>\n              <span id="presence-text">Desconectado</span>\n            </div>\n          </div>\n\n          <div\n            class="aware-chat-header-typing"\n            id="typing-indicator"\n            style="display:none;"\n          >\n            Escribiendo‚Ä¶\n          </div>\n        </div>\n\n        <div class="aware-chat-body" id="chat-body">\n          Cargando mensajes...\n        </div>\n\n        <div\n          class="aware-attachments-preview"\n          id="attachments-preview"\n        ></div>\n\n        <div class="aware-chat-input">\n          <input\n            type="text"\n            id="chat-input"\n            placeholder="Escribe un mensaje‚Ä¶"\n          />\n          <button class="aware-attach-btn" id="attach-btn">üìé</button>\n          <input type="file" id="file-input" multiple style="display:none;" />\n          <button class="aware-send-btn" id="send-btn" title="Enviar">\n            ‚û§\n          </button>\n        </div>\n      `;var t=this.container.querySelector("#chat-body"),n=this.container.querySelector("#attach-btn"),i=this.container.querySelector("#file-input"),a=this.container.querySelector("#chat-input"),s=this.container.querySelector("#send-btn");function o(){if(e.ws.send({type:"typing",is_typing:!1}),!e.isSending){var t=a.value.trim();(t||0!==e.pendingAttachments.length)&&(e.isSending=!0,e.pendingText=t,e.ws.send({type:"message",text:t}),a.value="")}}n.onclick=function(){i.click()},i.onchange=function(){Array.from(i.files).forEach(function(t){e.pendingAttachments.push(t)}),e._renderAttachmentPreviews(),i.value=""},this.api.getMessages(this.state.conversation.id).then(function(n){t.innerHTML="";var i=Object.values(n);i.length?(i.forEach(function(t){e._appendMessage(t)}),t.scrollTop=t.scrollHeight):t.innerHTML="<p>No hay mensajes</p>"}).catch(function(e){t.innerHTML="<p>Error cargando mensajes</p>",console.error(e)}),s.onclick=o,a.onkeydown=function(e){"Enter"===e.key&&o()};var r=null;a.oninput=function(){e.ws.send({type:"typing",is_typing:!0}),clearTimeout(r),r=setTimeout(function(){e.ws.send({type:"typing",is_typing:!1})},1e3)},this.container.querySelector("#back").onclick=function(){e.ws.disconnect(),e.navigate("inbox")},e.ws.disconnect(),e.ws.connect(this.state.conversation.id,{onOpen:function(){e.ws.send({type:"read"})},onMessage:function(t){e._handleWsEvent(t)}})},a.prototype._handleWsEvent=function(e){if("message"===e.type)return"conversation"!==this.state.view&&e.message.sender!==this.options.currentUserId&&(this.totalUnread+=1,this._renderLauncherBadge()),"conversation"!==this.state.view&&this._incrementInboxBadge(e.message.conversation_id),void("conversation"===this.state.view&&this._handleOwnMessageCreated(e.message));"typing"===e.type&&this._handleTyping(e),"presence"===e.type&&this._handlePresence(e),"read"===e.type&&this._handleReadReceipt(e),"attachment"===e.type&&this._appendAttachment(e.message_id,e.attachment)},a.prototype._handleOwnMessageCreated=function(e){if(this._appendMessage(e),this.pendingAttachments.length){var t=e.id,n=this,i=this.pendingAttachments.map(function(e){return n.api.uploadAttachment(t,e)});Promise.all(i).then(function(){n._resetPendingState()}).catch(function(e){console.error("Error subiendo adjuntos",e),n._resetPendingState()})}else this._resetPendingState()},a.prototype._appendMessage=function(e){var t=this.container.querySelector("#chat-body");if(t){var n=e.attachments&&1===e.attachments.length&&e.attachments[0].file_type.startsWith("image")&&!e.text,i=e.sender===this.options.currentUserId,a=document.createElement("div");a.className="aware-message "+(i?"mine":"other")+(n?" image-only":""),a.setAttribute("data-message-id",e.id);var s,o,r=`\n      <div class="message-text">${e.text||""}</div>\n      <div class="message-meta">\n        <span class="message-date">${s=e.created_at,o=new Date(s),o.toLocaleDateString()+" "+o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>\n        ${i?'<span class="message-status">‚úì</span>':""}\n      </div>\n    `;e.attachments&&e.attachments.length&&e.attachments.forEach(function(e){if(e.file_type.startsWith("image"))r+=`\n            <img src="${e.file}" class="chat-image" />\n          `;else{var t=e.file.split("/").pop();r+=`\n            <div class="chat-attachment chat-attachment-pdf">\n              <div class="chat-attachment-icon">üìÑ</div>\n              <div class="chat-attachment-info">\n                <div class="chat-attachment-name">${t}</div>\n                <div class="chat-attachment-meta">\n                  ${(e.file_size/1024).toFixed(0)} KB\n                </div>\n                <a\n                  href="${e.file}"\n                  target="_blank"\n                  class="chat-attachment-link"\n                >\n                  Descargar\n                </a>\n              </div>\n            </div>\n          `}}),a.innerHTML=r,t.appendChild(a),t.scrollTop=t.scrollHeight}},a.prototype._appendAttachment=function(e,t){var n=this.container.querySelector('[data-message-id="'+e+'"]');if(n)if(t.file_type.startsWith("image"))n.innerHTML+=`\n        <img src="${t.file}" class="chat-image" />\n      `;else{var i=t.file.split("/").pop();n.innerHTML+=`\n        <div class="chat-attachment chat-attachment-pdf">\n          <div class="chat-attachment-icon">üìÑ</div>\n          <div class="chat-attachment-info">\n            <div class="chat-attachment-name">${i}</div>\n            <div class="chat-attachment-meta">\n              ${(t.file_size/1024).toFixed(0)} KB\n            </div>\n            <a\n              href="${t.file}"\n              target="_blank"\n              class="chat-attachment-link"\n            >\n              Descargar\n            </a>\n          </div>\n        </div>\n      `}},a.prototype._renderAttachmentPreviews=function(){var e=this.container.querySelector("#attachments-preview");if(e){e.innerHTML="";var t=this;this.pendingAttachments.forEach(function(n,i){var a=document.createElement("div");if(a.className="attachment-preview",n.type.startsWith("image")){var s=document.createElement("img");s.src=URL.createObjectURL(n),a.appendChild(s)}else a.innerHTML+=`\n          üìÑ ${n.name} (${(n.size/1024).toFixed(0)} KB)\n        `;var o=document.createElement("span");o.className="remove",o.innerText="‚úñ",o.onclick=function(){t.pendingAttachments.splice(i,1),t._renderAttachmentPreviews()},a.appendChild(o),e.appendChild(a)})}},a.prototype._handleTyping=function(e){if(console.log(this.options.isDoctor),e.sender_role!==(this.options.isDoctor?"doctor":"patient")){var t=this.container.querySelector("#typing-indicator");t&&(e.is_typing?(t.style.display="block",t.innerText="Escribiendo..."):t.style.display="none")}},a.prototype._handlePresence=function(e){if(e.user_id!==this.options.currentUserId){var t=this.container.querySelector("#presence-dot"),n=this.container.querySelector("#presence-text");t&&n&&(e.is_online?(t.classList.remove("offline"),t.classList.add("online"),n.innerText="En linea"):(t.classList.remove("online"),t.classList.add("offline"),n.innerText="Desconectado"))}},a.prototype._handleReadReceipt=function(e){this.container.querySelectorAll(".message-status").forEach(function(e){e.innerText="‚úì‚úì"})},a.prototype._updateTotalUnread=function(e){var t=0;e.forEach(function(e){t+=e.unread_count||0}),this.totalUnread=t,this._renderLauncherBadge()},a.prototype._renderLauncherBadge=function(){if(this.launcher){var e=this.launcher.querySelector("#launcher-badge");e&&(this.totalUnread>0?(e.innerText=this.totalUnread,e.classList.remove("hidden")):e.classList.add("hidden"))}},a.prototype._incrementInboxBadge=function(e){var t=this.container.querySelector('[data-conversation-id="'+e+'"]');if(t){var n=t.querySelector(".inbox-badge");if(n)n.innerText=parseInt(n.innerText,10)+1;else{var i=t.querySelector(".inbox-meta"),a=document.createElement("span");a.className="inbox-badge",a.innerText="1",i.appendChild(a)}}},a.prototype._clearInboxBadge=function(e){var t=this.container.querySelector('[data-conversation-id="'+e+'"]');if(t){var n=t.querySelector(".inbox-badge");n&&n.remove()}},a.prototype._resetPendingState=function(){this.pendingAttachments=[],this.pendingText="",this.pendingMessageId=null,this.isSending=!1;var e=this.container.querySelector("#attachments-preview");e&&(e.innerHTML="")},a.prototype._resetWidget=function(){this.ws&&this.ws.disconnect(),this.state.view="inbox",this.state.conversation.id=null,this.state.conversation.receiver=null,this.state.conversation.messages=[],this.pendingAttachments=[],this.pendingText="",this.pendingMessageId=null,this.isSending=!1,this.container&&(this.container.innerHTML="")},"undefined"!=typeof window&&(window.ChatWidget=a),a}();
